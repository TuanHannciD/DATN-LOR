@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model AuthDemo.Models.ViewModels.ProductDetailsVM
@{
    ViewData["Title"] = "SanPhamdetails";
    Layout = "~/Views/Shared/_LayoutPdetail.cshtml";
}
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
@if (TempData["SuccessMessage"] != null)
{
<div id="toastSuccess" class="toast-toast">
<div class="toast-icon">✔</div>
<div class="toast-content">

<strong>Success</strong><br />
@TempData["SuccessMessage"]
</div>
<div class="toast-close" onclick="closeToast()">×</div>
</div>
}


<section class="product-details spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-6 col-md-6">
                <div class="product__details__pic">
                    <div class="product__details__pic__item" style="width: 500px;">
                    <img class="product__details__pic__item--large"
                             src="@Url.Content("~/AnhDoiGiay/" + Model.giay.AnhDaiDien)" alt="">
                    </div>
                    <div class="product__details__pic__slider owl-carousel">
                    @foreach (var img in Model.DanhSachAnh)
                    {
                            <img data-imgbigurl="@Url.Content("~/AnhDoiGiay/" + img)"
                                 src="@Url.Content("~/AnhDoiGiay/" + img)" alt="">

                    }

                    </div>
                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <div class="product__details__text">
                    <h3>@Model.giay.TenGiay</h3>

                    <div class="product__details__price" id="giaSanPham">@ViewBag.Gia.ToString("N0") VNĐ </div>

                    <div class="product__details__quantity">

                        @* ------- FORM ------- *@
                        <form id="addToCartForm" style="max-width:400px;padding:20px;border:1px solid #ddd;border-radius:8px;background:#f9f9f9;">

                            @* Anti‑Forgery (nếu bạn bật ValidateAntiForgeryToken ở controller) *@
                            @Html.AntiForgeryToken()

                            <!-- Số lượng -->
                            <div class="form-group" style="margin-bottom: 15px;">
                                <label style="font-weight:bold; display:block; margin-bottom:6px;">Số lượng:</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <button type="button" id="decreaseQty" style="padding:6px 12px; border:none; background:#eee; font-weight:bold;">–</button>
                                    <input type="number" id="quantity" name="quantity"  value="1" style="width:60px; text-align:center; padding:4px 8px; border:1px solid #ccc; border-radius:4px;" />
                                    <button type="button" id="increaseQty" style="padding:6px 12px; border:none; background:#eee; font-weight:bold;">+</button>
                                    <span id="stockStatus" style="margin-left:10px; color:#4caf50;"> </span>
                                </div>
                            </div>

                            <!-- Màu sắc -->
                            <div class="form-group" style="margin-bottom:8px;">
                                <label style="font-weight:bold;">Màu sắc:</label>
                                <div id="mauSacGroup" style="display:flex;gap:8px;flex-wrap:wrap;">
                                    @foreach (var mau in Model.MauSacOptions)
                                    {
                                        <button type="button" class="mau-option"
                                                data-id="@mau.ColorID"
                                                style="border:1px solid #ccc;padding:8px 12px;border-radius:4px;cursor:pointer;">
                                            @mau.TenMau
                                        </button>
                                    }
                                </div>
                            </div>

                            <!-- Kích cỡ -->
                            <div class="form-group">
                                <label style="font-weight:bold;">Kích cỡ:</label>
                                <div id="kichCoGroup" style="display:flex;gap:8px;flex-wrap:wrap;">
                                    @foreach (var size in Model.KichCoOptions)
                                    {
                                        <button type="button" class="size-option"
                                                data-id="@size.SizeID"
                                                style="border:1px solid #ccc;padding:8px 12px;border-radius:4px;cursor:pointer;">
                                            @size.TenKichThuoc
                                        </button>
                                    }
                                </div>
                            </div>

                            <!-- Hidden fields -->
                            <input type="hidden" id="selectedColorId" />
                            <input type="hidden" id="selectedSizeId" />
                            <input type="hidden" id="productId" value="@Model.giay.ShoeID" />

                            <!-- Submit -->
                            <button type="submit" class="primary-btn"
                                    style="padding:10px 20px;font-size:14px;background:#7fad39;color:#fff;border:none;border-radius:4px;cursor:pointer;">
                                Thêm vào giỏ hàng
                            </button>
                        </form>

                        @* ------- TOAST ------- *@
                        <div id="toastBox" class="toast">
                            
                            <div class="toast-content" id="toastText">Thông báo</div>
                            <div class="toast-close" onclick="hideToast()">×</div>
                        </div>
                                 

                    </div>


                    @*  <div class="addspyt" data-id="@ViewBag.Idsp"><a class="heart-icon"><span class="icon_heart_alt"></span></a> *@
                    <ul>

                        @*  <li><b>Cân Nặng:</b> <span>@ViewBag.CanNang</span></li>
                        <li><b>Kho: </b> <span>@ViewBag.SoLuongBan</span></li>
                        <li><b>Mô Tả: </b> <span>@ViewBag.MoTa</span></li> *@
                        

                    </ul>
                </div>
            </div>

        </div>
    </div>
    </div>
    </div>
    @section Scripts {
        <script>
            const colorBtns = document.querySelectorAll(".mau-option");
            const sizeBtns = document.querySelectorAll(".size-option");
            const colorInp = document.getElementById("selectedColorId");
            const sizeInp = document.getElementById("selectedSizeId");
            const shoeId = document.getElementById("productId").value;

            function updateStockAndPrice() {
                if (colorInp.value && sizeInp.value) {
                    // Gọi số lượng tồn
                    fetch(`/Home/GetSoLuongTon?shoeId=${shoeId}&colorId=${colorInp.value}&sizeId=${sizeInp.value}`)
                        .then(res => res.json())
                        .then(data => {
                            const stockEl = document.getElementById("stockStatus");
                            if (data.success) {
                                stockEl.textContent = `${data.soLuong} Sản phẩm`;
                                stockEl.style.color = "#4caf50";
                            } else {
                                stockEl.textContent = "Không có hàng";
                                stockEl.style.color = "#dc3545";
                            }
                        });

                    // Gọi giá
                    fetch(`/Home/GetGiaChiTiet?shoeId=${shoeId}&colorId=${colorInp.value}&sizeId=${sizeInp.value}`)
                        .then(res => res.json())
                        .then(data => {
                            const giaEl = document.getElementById("giaSanPham");
                            if (data.success) {
                                giaEl.textContent = data.gia.toLocaleString('vi-VN') + ' vnđ';
                            } else {
                                giaEl.textContent = 'Không có giá';
                            }
                        });
                }
            }

            colorBtns.forEach(btn => btn.addEventListener("click", () => {
                colorBtns.forEach(b => b.classList.remove("selected"));
                btn.classList.add("selected");
                colorInp.value = btn.dataset.id;
                updateStockAndPrice();
            }));

            sizeBtns.forEach(btn => btn.addEventListener("click", () => {
                sizeBtns.forEach(b => b.classList.remove("selected"));
                btn.classList.add("selected");
                sizeInp.value = btn.dataset.id;
                updateStockAndPrice();
            }));
        </script>
    }
</section>
<!-- Related Product Section Begin -->
<section class="related-product">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="section-title related__product__title">
                    <h2>Sản phẩm liên quan</h2>
                </div>
            </div>
        </div>
        <div class="row">
            @foreach (var item in Model.SanPhamLienQuan)
            {
                <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                    <div class="product__item">
                        <a asp-controller="Home" asp-action="SanPhamdetails" asp-route-id="@item.Giay.ShoeID">
                            <div class="featured__item__pic set-bg" data-setbg="@Url.Content("~/AnhDoiGiay/" + item.Giay.AnhDaiDien)"
                                 style="background-image: url(&quot;img/featured/feature-1.jpg&quot;); width: 250px; height: 200px;">
                            </div>
                            <div class="featured__item__text">
                                <h6><a asp-controller="Home" asp-action="SanPhamdetails" asp-route-id="@item.Giay.ShoeID">@item.Giay.TenGiay</a></h6>

                                @* <h6><a asp-controller="Home" asp-action="SanPhamDetails" asp-route-Masp="@item.IdSp">@item.TenSp</a></h6> *@
                                <h5> @item.GiaMin.ToString("N0") vnđ </h5>
                            </div>
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</section>
<!-- Related Product Section End -->


<script>
    // Nút tăng/giảm số lượng
   

    document.getElementById('decreaseQty').addEventListener('click', function () {
        var qty = document.getElementById('quantity');
        if (parseInt(qty.value) > 1) qty.value = parseInt(qty.value) - 1;
    });

    document.getElementById('increaseQty').addEventListener('click', function () {
        var qty = document.getElementById('quantity');
        qty.value = parseInt(qty.value) + 1;
    });

    document.addEventListener("DOMContentLoaded", () => {

        /* ----- chọn màu & size ----- */
        const colorBtns = document.querySelectorAll(".mau-option");
        const sizeBtns = document.querySelectorAll(".size-option");
        const colorInp = document.getElementById("selectedColorId");
        const sizeInp = document.getElementById("selectedSizeId");

        // chọn màu
        colorBtns.forEach(btn => btn.addEventListener("click", () => {
            colorBtns.forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            colorInp.value = btn.dataset.id;

            const productId = document.getElementById("productId").value;

            // Lấy các size còn hàng với màu đã chọn
            fetch(`/Home/GetAvailableSizes?shoeId=${productId}&colorId=${colorInp.value}`)
                .then(res => res.json())
                .then(validSizeIds => {
                    sizeBtns.forEach(sizeBtn => {
                        const sizeId = sizeBtn.dataset.id;
                        if (validSizeIds.includes(sizeId)) {
                            sizeBtn.disabled = false;
                            sizeBtn.classList.remove("disabled");
                        } else {
                            sizeBtn.disabled = true;
                            sizeBtn.classList.add("disabled");
                        }
                    });
                });

            if (colorInp.value && sizeInp.value) {
                fetch(`/Home/GetSoLuongTon?shoeId=${productId}&colorId=${colorInp.value}&sizeId=${sizeInp.value}`)
                    .then(res => res.json())
                    .then(data => {
                        const stockEl = document.getElementById("stockStatus");
                        if (data.success) {
                            stockEl.textContent = `${data.soLuong} Sản phẩm`;
                            stockEl.style.color = "#4caf50";
                        } else {
                            stockEl.textContent = "Không có hàng";
                            stockEl.style.color = "#dc3545";
                        }
                    });
            }
        }));
        // chọn size
        sizeBtns.forEach(btn => btn.addEventListener("click", () => {
            sizeBtns.forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            sizeInp.value = btn.dataset.id;

            const productId = document.getElementById("productId").value;

            // Lấy các màu còn hàng với size đã chọn
            fetch(`/Home/GetAvailableColors?shoeId=${productId}&sizeId=${sizeInp.value}`)
                .then(res => res.json())
                .then(validColorIds => {
                    colorBtns.forEach(colorBtn => {
                        const colorId = colorBtn.dataset.id;
                        if (validColorIds.includes(colorId)) {
                            colorBtn.disabled = false;
                            colorBtn.classList.remove("disabled");
                        } else {
                            colorBtn.disabled = true;
                            colorBtn.classList.add("disabled");
                        }
                    });
                });

            if (colorInp.value && sizeInp.value) {
                fetch(`/Home/GetSoLuongTon?shoeId=${productId}&colorId=${colorInp.value}&sizeId=${sizeInp.value}`)
                    .then(res => res.json())
                    .then(data => {
                        const stockEl = document.getElementById("stockStatus");
                        if (data.success) {
                            stockEl.textContent = `${data.soLuong} Sản phẩm`;
                            stockEl.style.color = "#4caf50";
                        } else {
                            stockEl.textContent = "Không có hàng";
                            stockEl.style.color = "#dc3545";
                        }
                    });
            }
        }));

        /* ----- toast helpers ----- */
        const toastBox = document.getElementById("toastBox");
        const toastTxt = document.getElementById("toastText");
        window.hideToast = () => { toastBox.classList.remove("show"); };

        function showToast(msg, isSuccess = true) {
            toastTxt.textContent = msg;
            toastBox.style.background = isSuccess ? "#28a745" : "#dc3545";
            toastBox.classList.add("show");
            setTimeout(hideToast, 3000);
        }

        /* ----- AJAX submit ----- */
        const form = document.getElementById("addToCartForm");
        const url = '@Url.Action("Cart", "Home")';

        form.addEventListener("submit", e => {
            e.preventDefault();

            if (!colorInp.value || !sizeInp.value) {
                showToast("Vui lòng chọn đầy đủ màu và kích cỡ!", false);
                return;
            }

            const data = {
                id: document.getElementById("productId").value,
                MauSacId: colorInp.value,
                KichCoId: sizeInp.value,
                quantity: document.getElementById("quantity").value,
                __RequestVerificationToken:
                    document.querySelector('input[name="__RequestVerificationToken"]').value
            };

            fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams(data)
            })
                .then(r => r.json())
                .then(res => {
                    if (res.redirect) {
                        window.location.href = res.redirect;
                        return;
                    }

                    showToast(res.message, res.success);
                    if (res.success) {
                        // ví dụ: cập nhật số lượng giỏ hàng trên header
                        // document.getElementById("cartCount").textContent = res.cartCount;
                    }
                })
        });


    });
       
</script>

